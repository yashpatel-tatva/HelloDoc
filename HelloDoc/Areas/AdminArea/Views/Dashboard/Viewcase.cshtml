@{
    Layout = null;
}
@using DataModels.AdminSideViewModels;
@model RequestDataViewModel;
<form data-id="@Model.RequestId" value="@Model.FirstName @Model.LastName">
    <div class="container">
        <div class="d-flex justify-content-between">
            <div class="viewcaseactionbtns d-flex justify-content-start align-items-center"><span class="h4 mb-0">@Model.Statusname(Model.Status) Request</span> &nbsp;<span class="p-1 text-white rounded-3 bg-success">@Model.RequestTypeName(Model.RequesttypeID)</span></div>
            <div>
                @*<a asp-controller="Home" asp-action="AdminTabsLayout">*@
                <button class="d-flex backbtncase babtn rounded align-item-center p-1 px-2">
                    <div><img src="~/res/back.png" width="15px" height="10px"></div>
                    <div><span>Back</span></div>
                </button>
                @*</a>*@
            </div>
        </div>
        <div class="bg-light rounded-3 p-3 mt-2 shadow" id="content">
            <div class="h5 fw-bold">Patient Information</div>
            <div class="mt-2">
                <div class="small text-muted">Confirmation Number</div>
                <div class="text-info">@Model.ConfirmationNo</div>
            </div>
            <div class="py-2 col-12 ">
                <div class="form-group rounded d-flex align-items-center">
                    <textarea class="form-control" placeholder="" rows="3" asp-for="Notes" readonly></textarea><span>Patient Notes</span>
                </div>
            </div>
            <hr style="border : 1px dashed grey" />
            <div class="row d-flex">
                <div class="py-2 col-xl-6 col-md-6 col-sm-12">
                    <div class="form-group d-flex align-items-center rounded">
                        <input type="text" class="form-control" placeholder="" asp-for="FirstName" readonly><span>First Name</span>
                    </div>
                    <span asp-validation-for="FirstName"></span>
                </div>
                <div class="py-2 col-xl-6 col-md-6 col-sm-12">
                    <div class="form-group d-flex align-items-center rounded">
                        <input type="text" class="form-control" placeholder="" asp-for="LastName" readonly><span>Last Name</span>
                    </div>
                    <span asp-validation-for="LastName"></span>
                </div>
                <div class="py-2 col-xl-6 col-md-6 col-sm-12">
                    <div class="form-group d-flex align-items-center rounded">
                        <input type="date" class="form-control" placeholder="" min="1940-01-01" max="2000-01-01" asp-for="PatientDOB" readonly><span>Date of Birth</span>
                    </div>
                </div>
                <div class="py-2 col-xl-5 col-md-5 col-sm-10 col-10">
                    <div class="telephone rounded">
                        <div class="input-group d-flex align-items-center rounded ">
                            @if (Model.Status != 1)
                            {
                                <input type="tel" id="tel" class="form-control" asp-for="PatientMobile" readonly>
                            }
                            else
                            {
                                <input type="tel" id="tel" class="form-control" asp-for="PatientMobile">
                            }
                        </div>
                    </div>
                    <span asp-validation-for="PatientMobile"></span>
                </div>
                <div class="py-2 col-xl-1 col-md-1 col-sm-2 col-2 ps-0">
                    <div class="border border-1 border-info d-flex w-100 h-100 align-items-center justify-content-center rounded">
                        <button class=" text-info border-0 bg-transparent"><i class="bi bi-telephone-fill" style="font-size : 1.5rem"></i></button>
                    </div>
                </div>
                <div class="py-2 col-xl-6 col-md-6 col-sm-12">
                    <div class="form-group d-flex align-items-center rounded">
                        @if (Model.Status != 1)
                        {
                            <input type="email" class="form-control" placeholder="" asp-for="PatientEmail" readonly>
                            <span>Email</span>
                        }
                        else
                        {
                            <input type="email" class="form-control" placeholder="" asp-for="PatientEmail">
                            <span>Email</span>
                        }
                    </div>
                    <span asp-validation-for="PatientEmail"></span>
                </div>
                @if (Model.Status == 1)
                {
                    <div class="py-2 col-xl-6 col-md-6 col-sm-12">
                        <div class="d-flex align-items-center rounded h-100">
                            <button class="form-group h-100 border border-1  border-info bg-transparent text-info rounded w-25" id="editbtn">Edit</button>
                        </div>
                    </div>
                }

            </div>
            <div class="h5 fw-bold">Location Information</div>
            <div class="d-flex row">
                <div class="py-2 col-xl-6 col-md-6 col-sm-12">
                    <div class="form-group d-flex align-items-center rounded">
                        <input type="text" class="form-control" placeholder="" asp-for="Region" readonly><span>Region</span>
                    </div>
                </div>
                <div class="py-2 col-xl-5 col-md-5 col-sm-10 col-10">
                    <div class="form-group d-flex align-items-center rounded">
                        <input type="text" class="form-control" placeholder="" asp-for="BusinessName" readonly><span>Business Name / Address</span>
                    </div>
                </div>
                <div class="py-2 col-xl-1 col-md-1 col-sm-2 col-2 ps-0">
                    <div class="border border-1 border-info d-flex w-100 h-100 align-items-center justify-content-center rounded">
                        <button class=" text-info border-0 bg-transparent"><i class="bi bi-geo-alt-fill" style="font-size : 1.5rem"></i></button>
                    </div>
                </div>
                <div class="py-2 col-xl-6 col-md-6 col-sm-12">
                    <div class="form-group d-flex align-items-center rounded">
                        <input type="text" class="form-control" placeholder="" readonly><span>Room#</span>
                    </div>
                </div>
            </div>
            <div class="d-flex justify-content-end viewcaseactionbtns">
                @if (Model.role == "Admin")
                {
                    @if (Model.Status == 1)
                    {
                        <div class="m-1"><button type="button" class="border-0 bg-info rounded-2 text-white p-2 gotopopup" action="AssignCase" data-toggle="modal" data-target="#AssignCasemodal" id="AssignCase">Assign</button></div>
                    }
                    <div class="m-1"><button class="border-0 bg-info rounded-2 text-white p-2" id="ViewNotes">View Notes</button></div>
                    @if (Model.Status == 1)
                    {
                        <div class="m-1"><button type="button" class="border-0 bg-danger rounded-2 text-white p-2 gotopopup" action="CancelCase" data-toggle="modal" data-target="#CancelCaseModal">Cancel</button></div>
                    }

                }
                else if (Model.role == "Physician")
                {
                    <div class="m-1"><button class="border-0 bg-info rounded-2 text-white p-2" id="ViewNotes">View Notes</button></div>
                    if (!Model.Isaccepted)
                    {
                        <div class="m-1"><button type="button" class="border-0 bg-success rounded-2 text-white p-2 gotoproviderpopup" action="AcceptCase">Accept</button></div>
                        <div class="m-1"><button type="button" class="border-0 bg-danger rounded-2 text-white p-2 gotoproviderpopup" action="DeclineCase">Decline</button></div>
                    }
                }
            </div>
        </div>
    </div>
</form>
<partial id="PopUps" />

<script src="~/js/statuses.js"></script>

<script>
    $('input[type="tel"]').each(function () {
        var iti = window.intlTelInput(this, {
            nationalMode: false,
            utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js"
        });
        $(this).on('blur', function () {
            var fullNumber = iti.getNumber();
            var countryCode = iti.getSelectedCountryData().dialCode;
            if (fullNumber.startsWith("+" + countryCode + "+" + countryCode)) {
                fullNumber = fullNumber.replace("+" + countryCode + "+", "+");
            }
            console.log(fullNumber);
            $(this).val(fullNumber);
        });
    });
    $(document).ready(function () {
        $('#ViewNotes').click(function (e) {
            e.preventDefault();

            var action = $(this).attr('id');
            var id = $(this).closest('form').data('id');

            $.ajax({
                url: '/AdminArea/Dashboard/' + action,
                type: 'GET',
                data: { id: id },
                success: function (result) {

                    $('#nav-tabContent').html(result);
                },
                error: function (xhr, status, error) {
                    console.error('Error: ' + error);
                },
            });
        });
        $('#editbtn').on('click', function () {
            var requestid = $(this).closest('form').data('id');
            console.log(requestid);
            var email = $("input[type='email']").val();
            var phone = $("input[type='tel']").val();
            var model = {
                requestid: requestid,
                patientemail: email,
                patientmobile: phone,
                pageredirectto: "ViewCase"
            };


            $.ajax({
                type: 'POST',
                url: '/AdminArea/Dashboard/EditEmailPhone',
                contentType: 'application/json',
                data: JSON.stringify(model),
                success: function (response) {
                    Swal.fire({
                        position: "top-end",
                        icon: "success",
                        title: "Email and Number Saved",
                        showConfirmButton: false,
                        timer: 1000
                    });
                    $('#nav-tabContent').html(response);
                },
                error: function (error) {
                    console.error('Error saving admin notes:', error);
                }
            });
        });
    });

    $('.gotoproviderpopup').on('click', function () {
        var action = $(this).attr('action');
        var id = $(this).closest('form').data('id');
        var text = "";
        var aftertext = "";
        if (action == "AcceptCase") {
            text = "Accept";
            aftertext = "Accepted"
            Swal.fire({
                title: "Are you sure?",
                text: "You want to " + text + " this!",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Yes, " + text + " it!"
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '/ProviderArea/Dashboard/' + action,
                        data: { id },
                        type: 'POST',
                        success: function (response) {
                            Swal.fire({
                                title: aftertext + "!",
                                text: "Case has been " + aftertext + ".",
                                icon: "success"
                            });
                            $('#nav-tabContent').html(response);
                        }
                    });
                }
            });
        }
        else {
            text = "Decline"
            aftertext = "Declined"
            Swal.fire({
                title: "Are you sure?",
                text: "You want to " + text + " this!",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Yes, " + text + " it!",
                input: "text",
                inputLabel: "Cancellation Notes",
                inputValidator: (value) => {
                    if (!value) {
                        return "You need to write something!";
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '/ProviderArea/Dashboard/' + action,
                        data: { id , note : result.value},
                        type: 'POST',
                        success: function (response) {
                            Swal.fire({
                                title: aftertext + "!",
                                text: "Case has been " + aftertext + ".",
                                icon: "success"
                            });
                            $('#nav-tabContent').html(response);
                        }
                    });
                }
            });
        }
        
    })


    $('.backbtncase').on('click', function () {
        location.reload();
    });
</script>